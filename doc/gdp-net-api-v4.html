<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Eric Allman" />
  <meta name="date" content="2017-12-13" />
  <title>What I Want to See in a Network API for the GDP</title>
  <style type="text/css">code{white-space: pre;}</style>
  <link href="data:text/css,%2F%2A%0A%20%2A%20I%20add%20this%20to%20html%20files%20generated%20with%20pandoc%2E%0A%20%2A%2F%0A%0Ahtml%20%7B%0A%20%20font%2Dsize%3A%20100%25%3B%0A%20%20overflow%2Dy%3A%20scroll%3B%0A%20%20%2Dwebkit%2Dtext%2Dsize%2Dadjust%3A%20100%25%3B%0A%20%20%2Dms%2Dtext%2Dsize%2Dadjust%3A%20100%25%3B%0A%7D%0A%0Abody%20%7B%0A%20%20color%3A%20%23444%3B%0A%20%20font%2Dfamily%3A%20Helvetica%2C%20Georgia%2C%20Palatino%2C%20%27Palatino%20Linotype%27%2C%20Times%2C%20%27Times%20New%20Roman%27%2C%20serif%3B%0A%20%20font%2Dsize%3A%2011pt%3B%0A%20%20line%2Dheight%3A%201%2E2%3B%0A%20%20padding%3A%201em%3B%0A%20%20margin%3A%20auto%3B%0A%20%20max%2Dwidth%3A%2042em%3B%0A%20%20background%3A%20%23fefefe%3B%0A%7D%0A%0Aa%20%7B%0A%20%20color%3A%20%230645ad%3B%0A%20%20text%2Ddecoration%3A%20none%3B%0A%7D%0A%0Aa%3Avisited%20%7B%0A%20%20color%3A%20%230b0080%3B%0A%7D%0A%0Aa%3Ahover%20%7B%0A%20%20color%3A%20%2306e%3B%0A%7D%0A%0Aa%3Aactive%20%7B%0A%20%20color%3A%20%23faa700%3B%0A%7D%0A%0Aa%3Afocus%20%7B%0A%20%20outline%3A%20thin%20dotted%3B%0A%7D%0A%0A%2A%3A%3A%2Dmoz%2Dselection%20%7B%0A%20%20background%3A%20rgba%28255%2C%20255%2C%200%2C%200%2E3%29%3B%0A%20%20color%3A%20%23000%3B%0A%7D%0A%0A%2A%3A%3Aselection%20%7B%0A%20%20background%3A%20rgba%28255%2C%20255%2C%200%2C%200%2E3%29%3B%0A%20%20color%3A%20%23000%3B%0A%7D%0A%0Aa%3A%3A%2Dmoz%2Dselection%20%7B%0A%20%20background%3A%20rgba%28255%2C%20255%2C%200%2C%200%2E3%29%3B%0A%20%20color%3A%20%230645ad%3B%0A%7D%0A%0Aa%3A%3Aselection%20%7B%0A%20%20background%3A%20rgba%28255%2C%20255%2C%200%2C%200%2E3%29%3B%0A%20%20color%3A%20%230645ad%3B%0A%7D%0A%0Ap%20%7B%0A%20%20margin%3A%201em%200%3B%0A%7D%0A%0Aimg%20%7B%0A%20%20max%2Dwidth%3A%20100%25%3B%0A%7D%0A%0Ah1%2C%20h2%2C%20h3%2C%20h4%2C%20h5%2C%20h6%20%7B%0A%20%20color%3A%20%23111%3B%0A%20%20line%2Dheight%3A%20125%25%3B%0A%20%20margin%2Dtop%3A%202em%3B%0A%20%20font%2Dweight%3A%20normal%3B%0A%7D%0A%0Ah4%2C%20h5%2C%20h6%20%7B%0A%20%20font%2Dweight%3A%20bold%3B%0A%7D%0A%0Ah1%20%7B%0A%20%20font%2Dsize%3A%202%2E5em%3B%0A%7D%0A%0Ah2%20%7B%0A%20%20font%2Dsize%3A%202em%3B%0A%7D%0A%0Ah3%20%7B%0A%20%20font%2Dsize%3A%201%2E5em%3B%0A%7D%0A%0Ah4%20%7B%0A%20%20font%2Dsize%3A%201%2E2em%3B%0A%7D%0A%0Ah5%20%7B%0A%20%20font%2Dsize%3A%201em%3B%0A%7D%0A%0Ah6%20%7B%0A%20%20font%2Dsize%3A%200%2E9em%3B%0A%7D%0A%0Ablockquote%20%7B%0A%20%20color%3A%20%23666666%3B%0A%20%20margin%3A%200%3B%0A%20%20padding%2Dleft%3A%203em%3B%0A%20%20border%2Dleft%3A%200%2E5em%20%23EEE%20solid%3B%0A%7D%0A%0Ahr%20%7B%0A%20%20display%3A%20block%3B%0A%20%20height%3A%202px%3B%0A%20%20border%3A%200%3B%0A%20%20border%2Dtop%3A%201px%20solid%20%23aaa%3B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23eee%3B%0A%20%20margin%3A%201em%200%3B%0A%20%20padding%3A%200%3B%0A%7D%0A%0Apre%2C%20code%2C%20kbd%2C%20samp%20%7B%0A%20%20color%3A%20%23000%3B%0A%20%20font%2Dfamily%3A%20monospace%2C%20monospace%3B%0A%20%20%5Ffont%2Dfamily%3A%20%27courier%20new%27%2C%20monospace%3B%0A%20%20font%2Dsize%3A%200%2E98em%3B%0A%7D%0A%0Apre%20%7B%0A%20%20background%3A%20%23eee%3B%0A%20%20white%2Dspace%3A%20pre%3B%0A%20%20white%2Dspace%3A%20pre%2Dwrap%3B%0A%20%20word%2Dwrap%3A%20break%2Dword%3B%0A%20%20border%3A%201px%20solid%20%23999%3B%0A%20%20padding%2Dright%3A%201em%3B%0A%20%20page%2Dbreak%2Dinside%3A%20avoid%3B%0A%7D%0A%0Ab%2C%20strong%20%7B%0A%20%20font%2Dweight%3A%20bold%3B%0A%7D%0A%0Adfn%20%7B%0A%20%20font%2Dstyle%3A%20italic%3B%0A%7D%0A%0Ains%20%7B%0A%20%20background%3A%20%23ff9%3B%0A%20%20color%3A%20%23000%3B%0A%20%20text%2Ddecoration%3A%20none%3B%0A%7D%0A%0Amark%20%7B%0A%20%20background%3A%20%23ff0%3B%0A%20%20color%3A%20%23000%3B%0A%20%20font%2Dstyle%3A%20italic%3B%0A%20%20font%2Dweight%3A%20bold%3B%0A%7D%0A%0Asub%2C%20sup%20%7B%0A%20%20font%2Dsize%3A%2075%25%3B%0A%20%20line%2Dheight%3A%200%3B%0A%20%20position%3A%20relative%3B%0A%20%20vertical%2Dalign%3A%20baseline%3B%0A%7D%0A%0Asup%20%7B%0A%20%20top%3A%20%2D0%2E5em%3B%0A%7D%0A%0Asub%20%7B%0A%20%20bottom%3A%20%2D0%2E25em%3B%0A%7D%0A%0Aul%2C%20ol%20%7B%0A%20%20margin%3A%201em%200%3B%0A%20%20padding%3A%200%200%200%202em%3B%0A%7D%0A%0Ali%20p%3Alast%2Dchild%20%7B%0A%20%20margin%2Dbottom%3A%200%3B%0A%7D%0A%0Aul%20ul%2C%20ol%20ol%20%7B%0A%20%20margin%3A%20%2E3em%200%3B%0A%7D%0A%0Adl%20%7B%0A%20%20margin%2Dbottom%3A%201em%3B%0A%7D%0A%0Adt%20%7B%0A%20%20font%2Dweight%3A%20bold%3B%0A%20%20margin%2Dbottom%3A%20%2E8em%3B%0A%7D%0A%0Add%20%7B%0A%20%20margin%3A%200%200%20%2E8em%202em%3B%0A%7D%0A%0Add%3Alast%2Dchild%20%7B%0A%20%20margin%2Dbottom%3A%200%3B%0A%7D%0A%0Aimg%20%7B%0A%20%20border%3A%200%3B%0A%20%20%2Dms%2Dinterpolation%2Dmode%3A%20bicubic%3B%0A%20%20vertical%2Dalign%3A%20middle%3B%0A%7D%0A%0Afigure%20%7B%0A%20%20display%3A%20block%3B%0A%20%20text%2Dalign%3A%20center%3B%0A%20%20margin%3A%201em%200%3B%0A%7D%0A%0Afigure%20img%20%7B%0A%20%20border%3A%20none%3B%0A%20%20margin%3A%200%20auto%3B%0A%7D%0A%0Afigcaption%20%7B%0A%20%20font%2Dsize%3A%200%2E8em%3B%0A%20%20font%2Dstyle%3A%20italic%3B%0A%20%20margin%3A%200%200%20%2E8em%3B%0A%7D%0A%0Atable%20%7B%0A%20%20margin%2Dbottom%3A%202em%3B%0A%20%20border%2Dbottom%3A%201px%20solid%20%23ddd%3B%0A%20%20border%2Dright%3A%201px%20solid%20%23ddd%3B%0A%20%20border%2Dspacing%3A%200%3B%0A%20%20border%2Dcollapse%3A%20collapse%3B%0A%7D%0A%0Atable%20th%20%7B%0A%20%20padding%3A%20%2E2em%201em%3B%0A%20%20background%2Dcolor%3A%20%23eee%3B%0A%20%20border%2Dtop%3A%201px%20solid%20%23ddd%3B%0A%20%20border%2Dleft%3A%201px%20solid%20%23ddd%3B%0A%7D%0A%0Atable%20td%20%7B%0A%20%20padding%3A%20%2E2em%201em%3B%0A%20%20border%2Dtop%3A%201px%20solid%20%23ddd%3B%0A%20%20border%2Dleft%3A%201px%20solid%20%23ddd%3B%0A%20%20vertical%2Dalign%3A%20top%3B%0A%7D%0A%0A%2Etitle%20%7B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0A%0A%2Eauthor%20%7B%0A%20%20font%2Dsize%3A%201%2E2em%3B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0A%0A%2Edate%20%7B%0A%20%20font%2Dsize%3A%200%2E8em%3B%0A%20%20text%2Dalign%3A%20center%3B%0A%7D%0A%0A%40media%20only%20screen%20and%20%28min%2Dwidth%3A%20480px%29%20%7B%0A%20%20body%20%7B%0A%20%20%20%20font%2Dsize%3A%2013px%3B%0A%20%20%7D%0A%7D%0A%40media%20only%20screen%20and%20%28min%2Dwidth%3A%20768px%29%20%7B%0A%20%20body%20%7B%0A%20%20%20%20font%2Dsize%3A%2015px%3B%0A%20%20%7D%0A%7D%0A%40media%20print%20%7B%0A%20%20%2A%20%7B%0A%20%20%20%20background%3A%20transparent%3B%0A%20%20%20%20color%3A%20black%3B%0A%20%20%20%20filter%3A%20none%3B%0A%20%20%20%20%2Dms%2Dfilter%3A%20none%3B%0A%20%20%7D%0A%0A%20%20body%20%7B%0A%20%20%20%20font%2Dsize%3A%2011pt%3B%0A%20%20%20%20max%2Dwidth%3A%20100%25%3B%0A%20%20%7D%0A%0A%20%20a%2C%20a%3Avisited%20%7B%0A%20%20%20%20text%2Ddecoration%3A%20underline%3B%0A%20%20%7D%0A%0A%20%20hr%20%7B%0A%20%20%20%20height%3A%201px%3B%0A%20%20%20%20border%3A%200%3B%0A%20%20%20%20border%2Dbottom%3A%201px%20solid%20black%3B%0A%20%20%7D%0A%0A%20%20a%5Bhref%5D%3Aafter%20%7B%0A%20%20%20%20content%3A%20%22%20%28%22%20attr%28href%29%20%22%29%22%3B%0A%20%20%7D%0A%0A%20%20abbr%5Btitle%5D%3Aafter%20%7B%0A%20%20%20%20content%3A%20%22%20%28%22%20attr%28title%29%20%22%29%22%3B%0A%20%20%7D%0A%0A%20%20%2Eir%20a%3Aafter%2C%20a%5Bhref%5E%3D%22javascript%3A%22%5D%3Aafter%2C%20a%5Bhref%5E%3D%22%23%22%5D%3Aafter%20%7B%0A%20%20%20%20content%3A%20%22%22%3B%0A%20%20%7D%0A%0A%20%20pre%20%7B%0A%20%20%20%20border%3A%201px%20solid%20%23999%3B%0A%20%20%20%20padding%2Dright%3A%201em%3B%0A%20%20%20%20page%2Dbreak%2Dinside%3A%20avoid%3B%0A%20%20%7D%0A%0A%20%20tr%2C%20img%20%7B%0A%20%20%20%20page%2Dbreak%2Dinside%3A%20avoid%3B%0A%20%20%7D%0A%0A%20%20img%20%7B%0A%20%20%20%20max%2Dwidth%3A%20100%25%20%21important%3B%0A%20%20%7D%0A%0A%20%20%40page%20%3Aleft%20%7B%0A%20%20%20%20margin%3A%2015mm%2020mm%2015mm%2010mm%3B%0A%7D%0A%0A%20%20%40page%20%3Aright%20%7B%0A%20%20%20%20margin%3A%2015mm%2010mm%2015mm%2020mm%3B%0A%7D%0A%0A%20%20p%2C%20h2%2C%20h3%20%7B%0A%20%20%20%20orphans%3A%203%3B%0A%20%20%20%20widows%3A%203%3B%0A%20%20%7D%0A%0A%20%20h2%2C%20h3%20%7B%0A%20%20%20%20page%2Dbreak%2Dafter%3A%20avoid%3B%0A%20%20%7D%0A%7D%0A" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="header">
<h1 class="title">What I Want to See in a Network API for the GDP</h1>
<h2 class="author">Eric Allman</h2>
<h3 class="date">2017-12-13</h3>
</div>
<p><strong><em>This is a proposal, not a specification</em></strong></p>
<p>This defines an API, not “bits on the wire” or, to the extent possible, specifics of implementation. The goal is that subject to a few constraints, everything “above the line” can be insulated from the actual network implementation, which must define the packet format in whatever way it sees fit. Conversely, everything “below the line” will not be in any way affected by changes in the higher level protocol. Obviously both of those specifications will be required, but this document isn’t the place.</p>
<p>SEE ALSO: Nitesh’s documents.</p>
<blockquote>
<p>[[Note: I’m doing a “proof of concept” implementation, essentially just adapting the current version, in order to test the API for completeness and simplicity. In that process I’m still finding new problems, so this <strong>WILL</strong> change.]]</p>
</blockquote>
<blockquote>
<p>[[NOTE: “PDU”, “blob”, and “payload” are used somewhat interchangeably, with a bit of “message” thrown in for good measure. This is a bug, not a feature. However, they differ from a “packet”, which is a property of the underlying physical medium.]]</p>
</blockquote>
<h2 id="key-points">Key Points</h2>
<p>This is essentially a message-based L4/L5 (Transport/Session Layer) model. The L5 part is about advertisements and routing. Normally routing would be L3 (Network Layer), but our model seems to be somewhat inverted in that the routing commands live on top of the reliable transmission layer. This is part of the legacy of the “overlay network” model.</p>
<p>For the purposes of this document, “I”, “me”, “my”, “up”, and “application direction” refer to the user of this API. “You”, “your”, “down”, and “network direction” refer to the implementer of the API. “Payload” is an opaque blob for you; the term is approximately equal to “PDU”.</p>
<blockquote>
<p>Using OSI language, a “payload” would be called a “Service Data Unit” or SDU. You add a header to that, and then it becomes the PDU for the next layer down. This document does not discuss the internal structure of the payload.</p>
</blockquote>
<p>GDP clients and servers (“my side” of the API) see:</p>
<ul>
<li>A message-based interface (i.e., PDUs are delimited by the network layer).</li>
<li>Reliable data transmission:
<ul>
<li>Fragmentation, flow control, etc. already handled.</li>
<li>Individual PDUs delivered reliably, that is, fragments of PDUs will be delivered in order, fragments will not be duplicated, and an error will be delivered if a fragment is lost.</li>
</ul></li>
<li>Different PDUs may be delivered out of order.</li>
<li>PDU sizes are not inherently limited by underlying MTUs.</li>
</ul>
<p>The network (“your side” of the API) sees (that is, I will give you):</p>
<ul>
<li>Source and destination GDPnames (256-bit).</li>
<li>Advertisements of known GDPnames, authenticated using a certificate-based scheme, still not fully defined.</li>
<li>Probably some hints vis-a-vis client expectations such as Quality of Service. These remain <em>for further study</em>.</li>
<li>A <code>libevent</code> event base to be used for registering I/O events. I may register my own events in the same event base.</li>
<li>Callbacks for functions that require higher level interaction, such as advertisements.</li>
<li><em>Other information to be determined.</em></li>
<li>I will run the event loop base as appropriate.</li>
</ul>
<p>Your side is responsible for:</p>
<ul>
<li>Advertising of known names, including refreshing leases.</li>
<li>Routing.</li>
<li>Retransmissions, etc.</li>
<li>Reestablishing dropped connections (e.g., in presence of router failure).</li>
<li>Fragmentation/Reassembly.</li>
<li>In order delivery (i.e., all pieces of the PDU delivered in order).</li>
<li>Compression (notably header compression).</li>
<li>On-the-wire crypto (TLS or DTLS as appropriate).</li>
<li>DoS mitigation. Attack traffic should be stopped as soon as possible.</li>
<li>Invoking callbacks when I/O events occur.</li>
</ul>
<p>“Your side” of the API can live partially in the client library, but some amount of it might live elsewhere, either in the switch/forwarder/router layer or in a separate service. I assume that this layer will not rely on threads in client processes to make it possible to run in low-end (non-MMU) processors. <em>Note: this is a change from the V3 design, which assumes a dedicated thread for I/O. This is intended to support Kubi’s dream of a semantically limited GDP in a single-threaded environment such as an Arduino.</em> However, some GDP applications may still use dedicated threads for I/O or other functions.</p>
<p>Issues that we should consider:</p>
<ul>
<li>All internal structure of messages (including signatures, etc) are hidden from the forwarding/routing layer. Is there anything else (other than source and destination identifiers) that needs to be exposed to the lower level (e.g., QoS requests)?
<ul>
<li>Nitesh says: ability to address individual replicas.</li>
<li>Nitesh says: ability to send to all replicas.</li>
<li>Eric says: anything needed for DoS mitigation? Maybe an HMAC key?</li>
</ul></li>
<li><p>This interface allows streaming receipt of data (within a single record) but not streaming transmission. How serious is this? Note: it’s impossible to write a header that includes the payload length until the size has been determined, which often means that the entire payload must be assembled in advance.</p></li>
<li><p>This should be easy to implement (from the network perspective) for the existing TCP-based, no fragmentation model, but is it reasonably sane for other I/O models?</p></li>
<li><p>Some way of doing multicast, notably for subscriptions.</p></li>
</ul>
<p>Design/Implementation Notes:</p>
<ul>
<li>This interface uses <code>libevent</code> (see <a href="http://libevent.org">http://libevent.org</a>). There is really no way around my picking the library without inverting the control flow, which would leave us forced to use threads. As a result, <code>libevent</code> semantics are built into this proposed API.</li>
</ul>
<p>Documentation Notes:</p>
<ul>
<li>This version is loosey-goosey with status codes. If we decide that this is a good direction I will provide more detail.</li>
</ul>
<h2 id="api">API</h2>
<p>The API is intended to map easily into an object-oriented paradigm with the first parameter to instance methods being <code>self</code>. Class methods generally return a status code; if they are allocating a new object it will be returned through the last parameter.</p>
<p>The parenthetical comments in the titles are intended to provide a model of how this would map into an OO environment.</p>
<h3 id="data-types-and-conventions">Data Types and Conventions</h3>
<p>The following data structures are opaque to “my side” of the API, but can be defined arbitrarily by “your side”:</p>
<ul>
<li><code>gdp_chan_t</code> contains the state of the channel itself. It is opaque to “my side” of the API.</li>
<li><code>gdp_adcert_t</code> is whatever information is needed to advertise a GDPname. This is <em>for further study</em>.</li>
<li><code>gdp_adchallenge_t</code> is data associated with a challenge/response interaction when doing advertising.</li>
<li><code>gdp_target_t</code> is intended for specifying clues as to where to deliver a message, for example, any replica, all replicas, or a specific replica. It is undefined as yet.</li>
</ul>
<p>The following data structures are opaque to “your side” of the API (i.e., you can never dereference them), but I can define to suit my needs:</p>
<ul>
<li><code>gdp_chan_x_t</code> contains “My” private data. This evaluates to <code>struct gdp_chan_x</code>, which I must define if I want to dereference that structure. It is normally referred to as <code>cdata</code> in the descriptions below.</li>
<li><code>gdp_advert_x_t</code> is my data structure used to pass information vis-a-vis advertising. It is normally referred to as <code>adata</code> in the descriptions below.</li>
</ul>
<p>These data structures are opaque to both of us; their interfaces are described in the “GDP Programmatic API” document:</p>
<ul>
<li><code>gdp_buf_t</code> implements dynamically allocated, variable sized buffers (already exists; based on <code>libevent</code> <code>evbuffer</code>s).</li>
<li><code>gdp_name_t</code> is the 256-bit version of a GDP name.</li>
</ul>
<h3 id="initialization">Initialization</h3>
<h4 id="gdp_chan_init-class-method">_gdp_chan_init (class method)</h4>
<p>I promise to call this routine on startup:</p>
<pre><code>    EP_STAT _gdp_chan_init(
            struct event_base *evbase,
            gdp_chan_init_t *options);</code></pre>
<p>The <code>evbase</code> parameter is a <code>libevent</code> event base that I will create and pass to you. The <code>options</code> parameter is for future use. Until then, I’ll always pass it as <code>NULL</code>.</p>
<h3 id="channel-management">Channel Management</h3>
<p>A Channel is a somewhat arbitrary class used to store whatever the network (“your”) side needs. I promise to create at least one channel when I start up.</p>
<h4 id="gdp_chan_open-constructor">_gdp_chan_open (constructor)</h4>
<pre><code>    typedef EP_STAT gdp_chan_recv_cb_t(
            gdp_chan_t *chan,
            gdp_name_t *src,
            gdp_name_t *dst,
            gdp_buf_t *payload);
    typedef EP_STAT gdp_chan_send_cb_t(
            gdp_chan_t *chan,
            gdp_buf_t *payload);
    typedef EP_STAT gdp_chan_ioevent_cb_t(
            gdp_chan_t *chan,
            int ioevent_flags);
    typedef EP_STAT gdp_chan_advert_func_t(
            gdp_chan_t *chan,
            int action);

    EP_STAT _gdp_chan_open(
            const char *addrspec,
            gdp_chan_qos_t *qos,
            gdp_chan_recv_cb_t *chan_recv_cb,
            gdp_chan_send_cb_t *chan_send_cb,
            gdp_chan_ioevent_cb_t *chan_ioevent_cb,
            gdp_chan_advert_func_t *advert_func,
            gdp_chan_x_t *cdata,
            gdp_chan_t **chan);</code></pre>
<p>Creates a channel to a GDP switch located at <code>addrspec</code> and stores the result in <code>*chan</code>. The format is a semicolon-delimited list of <code>hostname[:port]</code> entries. The entries in the list should be tried in order. If <code>addrspec</code> is NULL, Zeroconf should be tried if enabled, and if that fails the <code>swarm.gdp.routers</code> runtime parameter is used. If that is not set, <code>_gdp_chan_open</code> may try a default. If it cannot connect, it should return a status related to the reason (i.e., one based on a Posix <code>errno</code>) or <code>GDP_STAT_CHAN_NOT_CONNECTED</code>.</p>
<p>The <code>qos</code> parameter is intended to hold additional open parameters (e.g., QoS requirements), but for now I promise to pass it as <code>NULL</code>. If it non-NULL, you should return <code>GDP_STAT_NOT_IMPLEMENTED</code>.</p>
<p>The callbacks are described below.</p>
<p>The <code>cdata</code> parameter is saved and is available to callbacks on this channel. It is opaque on the network side.</p>
<p><strong><code>chan_recv_cb</code></strong>: When a new PDU is ready to read on the associated channel, call <code>chan_recv_cb</code>. Details are described under “Receiving Messages” below.</p>
<p><strong><code>chan_send_cb</code></strong>: The intent is that this will be called when the network is able to accept more data. It is not used at this time. For now, if it is non-NULL <code>_gdp_chan_open</code> should return <code>GDP_STAT_NOT_IMPLEMENTED</code>. The parameters to this function are subject to change.</p>
<p><strong><code>chan_ioevent_cb</code></strong>: When a channel is closed by the other end of the connection, or on I/O error, <code>gdp_ioevent_cb</code> is called. The <code>ioevent_flags</code> parameter is from the following set:</p>
<table>
<thead>
<tr class="header">
<th align="left">Flag</th>
<th align="left">Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><code>GDP_IOEVENT_CONNECT</code></td>
<td align="left">Connection established</td>
</tr>
<tr class="even">
<td align="left"><code>GDP_IOEVENT_EOF</code></td>
<td align="left">End of file on channel (i.e., it was closed)</td>
</tr>
<tr class="odd">
<td align="left"><code>GDP_IOEVENT_ERROR</code></td>
<td align="left">Error occurred on channel</td>
</tr>
</tbody>
</table>
<p>Note that this is a bitmap; multiple flags may be set on a single call.</p>
<p><strong><code>chan_advert_func</code></strong>: Invoked when advertising or withdrawal needs to take place. Advertising is required when the channel is connected or reconnected and in periodic lease updates. Withdrawal takes place when the client explicitly requests it or when the client is shutting down. The <code>action</code> parameter specifies whether this is for advertisement or withdrawal.</p>
<blockquote>
<p>[[Nitesh brings up the question of <code>dst</code> filtering. It isn’t clear which side of the interface this belongs on. Probably on your side since DoS mitigation should be as low level as possible.]]</p>
</blockquote>
<h4 id="gdp_chan_close-destructor">_gdp_chan_close (destructor)</h4>
<pre><code>    EP_STAT _gdp_chan_close(
            gdp_chan_t *chan);</code></pre>
<p>Deallocate <code>chan</code>. All resources are freed. I promise I will not attempt to use <code>chan</code> after it is freed.</p>
<h4 id="gdp_chan_get_cdata-changet_cdata">_gdp_chan_get_cdata (chan::get_cdata)</h4>
<pre><code>    gdp_chan_x_t *_gdp_chan_get_cdata(
            gdp_chan_t *chan);</code></pre>
<p>Returns the <code>cdata</code> associated with <code>chan</code>.</p>
<h3 id="advertising-and-certificates">Advertising and Certificates</h3>
<blockquote>
<p>[[Who is responsible for certificate management and advertisements? I guess that’s likely to be me. Drat.]]</p>
</blockquote>
<p>Note that the naive implementation of this interface would cause at least one round trip for each known name. This will be particularly expensive for log servers with large numbers of logs. One possible solution is to allow batching of advertisements, so the caller does something like:</p>
<pre><code>    _gdp_chan_advertise(chan, gnameA, ...);
    ...
    _gdp_chan_advertise(chan, gnameZ, ...);
    _gdp_chan_advert_commit(chan);</code></pre>
<p>This would cause an actual send to the routing layer. This would mean that challenge callbacks would not be synchronous with the <code>_gdp_chan_advertise</code> calls.</p>
<h4 id="gdp_chan_advertise-chanadvertise">_gdp_chan_advertise (chan::advertise)</h4>
<p><em>This interface is still under development.</em></p>
<pre><code>    // advertising challenge/response callback function type
    typedef EP_STAT (*gdp_chan_advert_cr_t)(
            gdp_chan_t *chan,
            gdp_name_t gname,
            int action,
            gdp_adchallenge_t *acdata,
            gdp_advert_x_t *adata);

    // advertisement method
    EP_STAT _gdp_chan_advertise(
            gdp_chan_t *chan,
            gdp_name_t gname,
            gdp_chan_adcert_t *adcert,
            gdp_advert_cr_t *challenge_cb,
            gdp_advert_x_t *adata);</code></pre>
<p>Advertises the name <code>gname</code> on the given <code>chan</code>. If a certificate needs to be presented, it should be passed as <code>adcert</code>. If the underlying layer needs further interaction (e.g., for challenge/response) it should call <code>challenge_cb</code>. The <code>adata</code> is passed through untouched.</p>
<p>If the routing subsystem challenges <code>adcert</code> the <code>challenge_cb</code> function will be invoked with the <code>chan</code>, the <code>gname</code> being challenged, an <code>action</code> <strong>to be determined</strong>, any challenge data issued by the router side as <code>acdata</code>, and the <code>adata</code> field directly from <code>_gdp_chan_advertise</code>.</p>
<blockquote>
<p>[[What is <code>adcert</code> exactly? Where does it come from?]]</p>
</blockquote>
<blockquote>
<p>[[We still need to explain how <code>acdata</code> is used.]]</p>
</blockquote>
<h4 id="gdp_chan_withdraw-chanwithdraw">_gdp_chan_withdraw (chan::withdraw)</h4>
<pre><code>    EP_STAT _gdp_chan_withdraw(
            gdp_chan_t *chan,
            gdp_name_t gname,
            gdp_advert_x_t *adata);</code></pre>
<p>Withdraw a previous advertisement, for example, if a log is removed from a given server.</p>
<blockquote>
<p>[[Question: should <code>_gdp_chan_advertise</code> return a data structure that can be passed to <code>_gdp_chan_withdraw</code> or is the gname enough?]]</p>
</blockquote>
<blockquote>
<p>[[Question: is there any point in sending <code>adata</code> here?]]</p>
</blockquote>
<h3 id="sending-messages">Sending Messages</h3>
<h4 id="gdp_chan_send-chansend">_gdp_chan_send (chan::send)</h4>
<pre><code>    EP_STAT _gdp_chan_send(
            gdp_chan_t *chan,
            gdp_target_t *target,
            gdp_name_t src,
            gdp_name_t dst,
            gdp_buf_t *payload);</code></pre>
<p>Sends the entire contents of <code>payload</code> to the indicated <code>dst</code> over <code>chan</code>. The source address is specified by <code>src</code>.</p>
<blockquote>
<p>[[Does this clear <code>payload</code> or leave it unchanged? Should probably clear it as the data is sent and acknowledged.]]</p>
</blockquote>
<p>The <code>target</code> give clues as to exactly where to deliver the message. For example, it might be any replica of a given log, all replicas of a given log (e.g., for quorum read), or a specific replica. It can also be used to indicate the equivalent of IPv4 “type of service” (precedence, reliability, etc). How it is specified is <em>for further study</em>. For now, I promise to pass in NULL; if it is not NULL, <code>GDP_STAT_NOT_IMPLEMENTED</code> should be returned.</p>
<blockquote>
<p>[[Issue: There are issues regarding allowing an arbitrary <code>src</code> that need to be explored. You should never be permitted to send from an address you aren’t authorized to speak for, but the ultimate responsibility for avoiding problems falls to the receiver.]]</p>
</blockquote>
<blockquote>
<p>[[Implementation Note: in the short run this may return <code>GDP_STAT_PDU_TOO_LONG</code> if the size of <code>payload</code> exceeds an implementation-defined limit. This should be as large as possible since it limits the size of any single record stored in the GDP.]]</p>
</blockquote>
<h4 id="gdp_chan_multicast-chanmulticast">_gdp_chan_multicast (chan::multicast)</h4>
<blockquote>
<p>[[Note: this is a placeholder.]]</p>
</blockquote>
<pre><code>    EP_STAT _gdp_chan_multicast(
            gdp_chan_t *chan,
            gdp_name_t src,
            gdp_mcaddr_t multicast_addr,
            gdp_buf_t *payload);</code></pre>
<p>Sends <code>payload</code> to multiple destinations as indicated by <code>multicast_addr</code>. It isn’t clear what that is.</p>
<p>This is primarily intended for delivering subscription data.</p>
<p>This will certainly need support to set up a multicast channel, probably with “new”, “join”, “leave”, and “free” style interface.</p>
<h3 id="receiving-messages">Receiving Messages</h3>
<p>Messages are delivered using the <code>gdp_chan_recv_cb</code> parameter to <code>_gdp_chan_open</code>. When a complete message is ready for delivery, this is function is called.</p>
<h3 id="utilities">Utilities</h3>
<h4 id="gdp_chan_lock-_gdp_chan_unlock-chanlock-chanunlock">_gdp_chan_lock, _gdp_chan_unlock (chan::lock, chan::unlock)</h4>
<pre><code>    void _gdp_chan_lock(
            gdp_chan_t *chan);

    void _gdp_chan_unlock(
            gdp_chan_t *chan);</code></pre>
<p>Lock or unlock a <code>chan</code>. This is a mutex lock.</p>
<blockquote>
<p>[[Can this be done implicitly? What in particular is it for?]]</p>
</blockquote>
<h2 id="status-codes">Status Codes</h2>
<p>To be completed.</p>
<ul>
<li><code>GDP_STAT_KEEP_READING</code></li>
<li><code>GDP_STAT_PDU_VERSION_MISMATCH</code></li>
<li><code>GDP_STAT_PDU_CORRUPT</code></li>
<li><code>GDP_STAT_NOTFOUND</code></li>
<li><code>GDP_STAT_PDU_WRITE_FAIL</code></li>
<li><code>GDP_STAT_NOT_IMPLEMENTED</code></li>
<li><code>GDP_STAT_CHAN_NOT_CONNECTED</code></li>
</ul>
<h2 id="implementation-notes">Implementation Notes</h2>
<p>These are primarily notes to myself, so don’t be concerned if the are hard to understand.</p>
<p><strong>Example startup</strong> (multi-threaded, my code). In pseudo-code:</p>
<pre><code>    _gdp_chan_init
        registers I/O events
    register timeout events
    spawn(event_loop)
    _gdp_chan_open
        (causes advertisements to be sent)
    return to application</code></pre>
<p>The event loop must be running before <code>_gdp_chan_open</code> so advertisement I/O can be handled as events.</p>
<p>For <strong>single threaded apps</strong>, all condition variables must be replaced. Unlike mutexes, they can’t just turn into no-ops. In some cases (notably <code>_gdp_invoke</code> and <code>gdp_event_next</code>) they turn into single calls to the event loop (with some trickiness around timeouts). In other cases (e.g., <code>chan-&gt;cond</code>) they should disappear entirely.</p>
</body>
</html>
